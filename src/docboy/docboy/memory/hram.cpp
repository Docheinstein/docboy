#include "docboy/memory/hram.h"

#if defined(ENABLE_CGB) && !defined(ENABLE_BOOTROM)
#include "docboy/cartridge/header.h"
#endif

namespace {
#ifndef ENABLE_BOOTROM
#ifdef ENABLE_CGB
const uint8_t HRAM_INITIAL_DATA[Specs::MemoryLayout::HRAM::SIZE] = {
    /* deterministic start */
    /* 0xFF80 */ 0xCE, 0xED, 0x66, 0x66, 0xCC, 0x0D, 0x00, 0x0B,
    /* 0xFF88 */ 0x03, 0x73, 0x00, 0x83, 0x00, 0x0C, 0x00, 0x0D,
    /* 0xFF90 */ 0x00, 0x08, 0x11, 0x1F, 0x88, 0x89, 0x00, 0x0E,
    /* 0xFF98 */ 0xDC, 0xCC, 0x6E, 0xE6, 0xDD, 0xDD, 0xD9, 0x99,
    /* 0xFFA0 */ 0xBB, 0xBB, 0x67, 0x63, 0x6E, 0x0E, 0xEC, 0xCC,
    /* 0xFFA8 */ 0xDD, 0xDC, 0x99, 0x9F, 0xBB, 0xB9, 0x33, 0x3E,
    /* deterministic end */
    /* 0xFFB0 */ 0xCB, 0x31, 0xB6, 0xCA, 0x6C, 0xEB, 0x57, 0x7D,
    /* 0xFFB8 */ 0x59, 0x30, 0x78, 0x64, 0x23, 0x42, 0x28, 0x87,
    /* 0xFFC0 */ 0x91, 0x77, 0x06, 0x48, 0xB1, 0x10, 0x34, 0xC6,
    /* 0xFFC8 */ 0x13, 0xF3, 0x99, 0x57, 0xC9, 0x87, 0xDA, 0x88,
    /* 0xFFD0 */ 0xA3, 0x86, 0x9C, 0xA7, 0x38, 0xB7, 0xC1, 0xA2,
    /* 0xFFD8 */ 0xF0, 0xBC, 0xF5, 0x5C, 0x99, 0x12, 0x9A, 0x81,
    /* 0xFFE0 */ 0x0A, 0x64, 0xF0, 0x87, 0xA7, 0x8E, 0xB5, 0x59,
    /* 0xFFE8 */ 0xAC, 0x54, 0x97, 0x0F, 0x38, 0x19, 0xC2, 0x77,
    /* 0xFFF0 */ 0xA1, 0x2D, /* deterministic start */ 0x71, 0x02, 0x4D, 0x01, 0xC1, 0xFF,
    /* 0xFFFA */ 0x0D, 0x00, 0xD3, 0x05, 0xF9, 0x00, /* deterministic end */ 0x00};

const uint8_t HRAM_DMG_MODE_INITIAL_DATA[Specs::MemoryLayout::HRAM::SIZE] = {
    /* deterministic start */
    /* 0xFF80 */ 0xCE, 0xED, 0x66, 0x66, 0xCC, 0x0D, 0x00, 0x0B,
    /* 0xFF88 */ 0x03, 0x73, 0x00, 0x83, 0x00, 0x0C, 0x00, 0x0D,
    /* 0xFF90 */ 0x00, 0x08, 0x11, 0x1F, 0x88, 0x89, 0x00, 0x0E,
    /* 0xFF98 */ 0xDC, 0xCC, 0x6E, 0xE6, 0xDD, 0xDD, 0xD9, 0x99,
    /* 0xFFA0 */ 0xBB, 0xBB, 0x67, 0x63, 0x6E, 0x0E, 0xEC, 0xCC,
    /* 0xFFA8 */ 0xDD, 0xDC, 0x99, 0x9F, 0xBB, 0xB9, 0x33, 0x3E,
    /* deterministic end */
    /* 0xFFB0 */ 0xCB, 0x31, 0xB6, 0xCA, 0x6C, 0xEB, 0x57, 0x7D,
    /* 0xFFB8 */ 0x59, 0x30, 0x78, 0x64, 0x23, 0x42, 0x28, 0x87,
    /* 0xFFC0 */ 0x91, 0x77, 0x06, 0x48, 0xB1, 0x10, 0x34, 0xC6,
    /* 0xFFC8 */ 0x13, 0xF3, 0x99, 0x57, 0xC9, 0x87, 0xDA, 0x88,
    /* 0xFFD0 */ 0xA3, 0x86, 0x9C, 0xA7, 0x38, 0xB7, 0xC1, 0xA2,
    /* 0xFFD8 */ 0xF0, 0xBC, 0xF5, 0x5C, 0x99, 0x12, 0x9A, 0x81,
    /* 0xFFE0 */ 0x0A, 0x64, 0xF0, 0x87, 0xA7, 0x8E, 0xB5, 0x59,
    /* 0xFFE8 */ 0xAC, 0x54, 0x97, 0x0F, 0x38, 0x19, 0xC2, 0x77,
    /* 0xFFF0 */ 0xA1, 0x2D, /* deterministic start */ 0x71, 0x02, 0x4D, 0x01, 0x00, 0xFF,
    /* 0xFFFA */ 0x0D, 0x00, 0xF5, 0x05, 0xF9, 0x00, /* deterministic end */ 0x00};

const uint8_t HRAM_DMG_MODE_COPY_LOGO_INITIAL_DATA[Specs::MemoryLayout::HRAM::SIZE] = {
    /* deterministic start */
    /* 0xFF80 */ 0xCE, 0xED, 0x66, 0x66, 0xCC, 0x0D, 0x00, 0x0B,
    /* 0xFF88 */ 0x03, 0x73, 0x00, 0x83, 0x00, 0x0C, 0x00, 0x0D,
    /* 0xFF90 */ 0x00, 0x08, 0x11, 0x1F, 0x88, 0x89, 0x00, 0x0E,
    /* 0xFF98 */ 0xDC, 0xCC, 0x6E, 0xE6, 0xDD, 0xDD, 0xD9, 0x99,
    /* 0xFFA0 */ 0xBB, 0xBB, 0x67, 0x63, 0x6E, 0x0E, 0xEC, 0xCC,
    /* 0xFFA8 */ 0xDD, 0xDC, 0x99, 0x9F, 0xBB, 0xB9, 0x33, 0x3E,
    /* deterministic end */
    /* 0xFFB0 */ 0xCB, 0x31, 0xB6, 0xCA, 0x6C, 0xEB, 0x57, 0x7D,
    /* 0xFFB8 */ 0x59, 0x30, 0x78, 0x64, 0x23, 0x42, 0x28, 0x87,
    /* 0xFFC0 */ 0x91, 0x77, 0x06, 0x48, 0xB1, 0x10, 0x34, 0xC6,
    /* 0xFFC8 */ 0x13, 0xF3, 0x99, 0x57, 0xC9, 0x87, 0xDA, 0x88,
    /* 0xFFD0 */ 0xA3, 0x86, 0x9C, 0xA7, 0x38, 0xB7, 0xC1, 0xA2,
    /* 0xFFD8 */ 0xF0, 0xBC, 0xF5, 0x5C, 0x99, 0x12, 0x9A, 0x81,
    /* 0xFFE0 */ 0x0A, 0x64, 0xF0, 0x87, 0xA7, 0x8E, 0xB5, 0x59,
    /* 0xFFE8 */ 0xAC, 0x54, 0x97, 0x0F, 0x38, 0x19, 0xC2, 0x77,
    /* 0xFFF0 */ 0xA1, 0x2D, /* deterministic start */ 0x71, 0x02, 0x4D, 0x01, 0x00, 0xFF,
    /* 0xFFFA */ 0x0D, 0x00, 0x03, 0x06, 0xF9, 0x00, /* deterministic end */ 0x00};

#else
// HRAM is usually random, apart from bytes [0xFFFA:0xFFFD] which are deterministic (used by SP for callstack).
const uint8_t HRAM_INITIAL_DATA[Specs::MemoryLayout::HRAM::SIZE] = {
    /* 0xFF80 */ 0x02,
    0xF2,
    0x42,
    0xC7,
    0x19,
    0x1F,
    0x6A,
    0xAC,
    /* 0xFF88 */ 0xC6,
    0xB3,
    0x2D,
    0x6F,
    0x33,
    0x65,
    0x8A,
    0xB3,
    /* 0xFF90 */ 0x3D,
    0x30,
    0x54,
    0xFC,
    0xC8,
    0x7E,
    0xB8,
    0x55,
    /* 0xFF98 */ 0x26,
    0xD5,
    0x69,
    0x68,
    0xBA,
    0x09,
    0x6E,
    0xBB,
    /* 0xFFA0 */ 0x27,
    0xD3,
    0x8D,
    0x16,
    0xF2,
    0xEC,
    0x4B,
    0xEB,
    /* 0xFFA8 */ 0x1D,
    0x06,
    0x10,
    0x4D,
    0xC4,
    0xE7,
    0x15,
    0x06,
    /* 0xFFB0 */ 0xCB,
    0x31,
    0xB6,
    0xCA,
    0x6C,
    0xEB,
    0x57,
    0x7D,
    /* 0xFFB8 */ 0x59,
    0x30,
    0x78,
    0x64,
    0x23,
    0x42,
    0x28,
    0x87,
    /* 0xFFC0 */ 0x91,
    0x77,
    0x06,
    0x48,
    0xB1,
    0x10,
    0x34,
    0xC6,
    /* 0xFFC8 */ 0x13,
    0xF3,
    0x99,
    0x57,
    0xC9,
    0x87,
    0xDA,
    0x88,
    /* 0xFFD0 */ 0xA3,
    0x86,
    0x9C,
    0xA7,
    0x38,
    0xB7,
    0xC1,
    0xA2,
    /* 0xFFD8 */ 0xF0,
    0xBC,
    0xF5,
    0x5C,
    0x99,
    0x12,
    0x9A,
    0x81,
    /* 0xFFE0 */ 0x0A,
    0x64,
    0xF0,
    0x87,
    0xA7,
    0x8E,
    0xB5,
    0x59,
    /* 0xFFE8 */ 0xAC,
    0x54,
    0x97,
    0x0F,
    0x38,
    0x19,
    0xC2,
    0x77,
    /* 0xFFF0 */ 0xA1,
    0x2D,
    0x2F,
    0x1D,
    0xB6,
    0x69,
    0x2B,
    0xF5,
    /* 0xFFFA */ 0xDE,
    0xB3,
    /* deterministic start */ 0x39,
    0x01,
    0x2E,
    0x00,
    /* deterministic end */ 0x00};
#endif
#endif
} // namespace

#if defined(ENABLE_CGB) && !defined(ENABLE_BOOTROM)
Hram::Hram(const CartridgeHeader& header) :
    header {header} {
}
#endif

void Hram::reset() {
#ifdef ENABLE_BOOTROM
    Memory::reset();
#else
#ifdef ENABLE_CGB
    if (CartridgeHeaderHelpers::is_cgb_game(header)) {
        Memory::reset(HRAM_INITIAL_DATA);
    } else {
        if (CartridgeHeaderHelpers::is_dmg_mode_copy_logo(header)) {
            Memory::reset(HRAM_DMG_MODE_COPY_LOGO_INITIAL_DATA);
        } else {
            Memory::reset(HRAM_DMG_MODE_INITIAL_DATA);
        }
    }
#else
    Memory::reset(HRAM_INITIAL_DATA);
#endif
#endif

    // Byte 0xFFFE is special: it seems to be initialized even before boot room execution.
    // On DMG it has value 0x4C, on CGB (also in DMG mode) it has value 0xC0. (TODO: further investigations?)
#ifdef ENABLE_CGB
    data[0xFFFE - Specs::MemoryLayout::HRAM::START] = 0xC0;
#else
    data[0xFFFE - Specs::MemoryLayout::HRAM::START] = 0x4C;
#endif
}
